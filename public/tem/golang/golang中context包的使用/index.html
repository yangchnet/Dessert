<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>golang中context包的使用 | Linote</title>
<meta name="keywords" content="golang, context" />
<meta name="description" content="context包定义了Context类型，这个类型在API边界即进程中传递截止日期、同步信号，请求值等相关信息。
 1. 对context包的介绍 在服务器的传入请求中应包含context，而对服务器的传出调用应接收一个context。它们之间的调用链必须包含context，或是衍生的WithCancel, WithDeadline, WithTimeout, WithValue。当一个WithCancel Context被“cancel”，那么当前context所派生的所有context也都将被取消。
WithCancel, WithDeadline, WithTimeout接收一个Context对象（父对象），并返回其父对象的一个携带有cancel/deadline/timeout的一个拷贝（子对象）。调用CancelFunc会取消其子对象及子对象的子对象等，删除父对象对子对象的引用，并停止所有关联的计时器。未能调用CancelFunc将造成父对象结束前或计时器被触发前子对象的泄露。使用go vet工具可以检查所有控制流路径上是否都使用了CancelFunc
使用context的程序应遵循以下规则，以使各个包之间的接口保持一致，并启用静态分析工具来检查上下文传播：
 不要将context存储在结构类型中，而是将context明确传递给需要它的每个函数。Context应该是第一个函数，通常命名为ctx。  func DoSomething(ctx context.Context, arg Arg) error { // ...use ctx... } 不要传递一个值为nil的context，即使一个函数允许这样做。如果你不确定Context的作用那就请传递context.TODO。 只在进程和API间传递请求范围数据时使用context值，不要用于将可选参数传递给函数。 同样的Context可以传递给运行在不同goroutine中的函数，Context是线程安全的。  2. Context接口 type Context interface { Done() &lt;-chan struct{} Err() error Deadline() (deadline time.Time, ok bool) Value(key interface{}) interface{} } Context是一个接口，其定义非常的简单，只包含4个方法：
  Done() &lt;-chan struct{} Done()方法将一个channel作为取消信号返回给持有context的函数，当该channel被关闭（即Done()被调用），这些函数应该立即停止其工作并返回。
  Err() error Err()返回一个Error，说明为什么取消context。如果Done()没有被调用，那么Err返回nil。
  Deadline() (deadline time.Time, ok bool) Deadline()方法返回持有这个context的函数的预期结束时间。如果并没有设置deadline，那么返回的ok将被设置为false。">
<meta name="author" content="李昌">
<link rel="canonical" href="http://lichang.tech/tem/golang/golang%E4%B8%ADcontext%E5%8C%85%E7%9A%84%E4%BD%BF%E7%94%A8/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.2d6dbfc6e0f8a1db1c9d082a76dc11d094328cf63f247bbc2421dfaa7f2bb170.css" integrity="sha256-LW2/xuD4odscnQgqdtwR0JQyjPY/JHu8JCHfqn8rsXA=" rel="preload stylesheet" as="style">
<link rel="preload" href="https://raw.githubusercontent.com/lich-Img/blogImg/master/img20210514094119.png" as="image">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://raw.githubusercontent.com/lich-Img/blogImg/master/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/lich-Img/blogImg/master/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/lich-Img/blogImg/master/favicon32.ico">
<link rel="apple-touch-icon" href="http://lichang.tech/apple-touch-icon.png">
<link rel="mask-icon" href="http://lichang.tech/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.81.0" />
<meta property="og:title" content="golang中context包的使用" />
<meta property="og:description" content="context包定义了Context类型，这个类型在API边界即进程中传递截止日期、同步信号，请求值等相关信息。
 1. 对context包的介绍 在服务器的传入请求中应包含context，而对服务器的传出调用应接收一个context。它们之间的调用链必须包含context，或是衍生的WithCancel, WithDeadline, WithTimeout, WithValue。当一个WithCancel Context被“cancel”，那么当前context所派生的所有context也都将被取消。
WithCancel, WithDeadline, WithTimeout接收一个Context对象（父对象），并返回其父对象的一个携带有cancel/deadline/timeout的一个拷贝（子对象）。调用CancelFunc会取消其子对象及子对象的子对象等，删除父对象对子对象的引用，并停止所有关联的计时器。未能调用CancelFunc将造成父对象结束前或计时器被触发前子对象的泄露。使用go vet工具可以检查所有控制流路径上是否都使用了CancelFunc
使用context的程序应遵循以下规则，以使各个包之间的接口保持一致，并启用静态分析工具来检查上下文传播：
 不要将context存储在结构类型中，而是将context明确传递给需要它的每个函数。Context应该是第一个函数，通常命名为ctx。  func DoSomething(ctx context.Context, arg Arg) error { // ...use ctx... } 不要传递一个值为nil的context，即使一个函数允许这样做。如果你不确定Context的作用那就请传递context.TODO。 只在进程和API间传递请求范围数据时使用context值，不要用于将可选参数传递给函数。 同样的Context可以传递给运行在不同goroutine中的函数，Context是线程安全的。  2. Context接口 type Context interface { Done() &lt;-chan struct{} Err() error Deadline() (deadline time.Time, ok bool) Value(key interface{}) interface{} } Context是一个接口，其定义非常的简单，只包含4个方法：
  Done() &lt;-chan struct{} Done()方法将一个channel作为取消信号返回给持有context的函数，当该channel被关闭（即Done()被调用），这些函数应该立即停止其工作并返回。
  Err() error Err()返回一个Error，说明为什么取消context。如果Done()没有被调用，那么Err返回nil。
  Deadline() (deadline time.Time, ok bool) Deadline()方法返回持有这个context的函数的预期结束时间。如果并没有设置deadline，那么返回的ok将被设置为false。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://lichang.tech/tem/golang/golang%E4%B8%ADcontext%E5%8C%85%E7%9A%84%E4%BD%BF%E7%94%A8/" /><meta property="og:image" content="http://lichang.tech/papermod-cover.png"/><meta property="article:section" content="Tem" />
<meta property="article:published_time" content="2021-05-23T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-05-23T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://lichang.tech/papermod-cover.png"/>

<meta name="twitter:title" content="golang中context包的使用"/>
<meta name="twitter:description" content="context包定义了Context类型，这个类型在API边界即进程中传递截止日期、同步信号，请求值等相关信息。
 1. 对context包的介绍 在服务器的传入请求中应包含context，而对服务器的传出调用应接收一个context。它们之间的调用链必须包含context，或是衍生的WithCancel, WithDeadline, WithTimeout, WithValue。当一个WithCancel Context被“cancel”，那么当前context所派生的所有context也都将被取消。
WithCancel, WithDeadline, WithTimeout接收一个Context对象（父对象），并返回其父对象的一个携带有cancel/deadline/timeout的一个拷贝（子对象）。调用CancelFunc会取消其子对象及子对象的子对象等，删除父对象对子对象的引用，并停止所有关联的计时器。未能调用CancelFunc将造成父对象结束前或计时器被触发前子对象的泄露。使用go vet工具可以检查所有控制流路径上是否都使用了CancelFunc
使用context的程序应遵循以下规则，以使各个包之间的接口保持一致，并启用静态分析工具来检查上下文传播：
 不要将context存储在结构类型中，而是将context明确传递给需要它的每个函数。Context应该是第一个函数，通常命名为ctx。  func DoSomething(ctx context.Context, arg Arg) error { // ...use ctx... } 不要传递一个值为nil的context，即使一个函数允许这样做。如果你不确定Context的作用那就请传递context.TODO。 只在进程和API间传递请求范围数据时使用context值，不要用于将可选参数传递给函数。 同样的Context可以传递给运行在不同goroutine中的函数，Context是线程安全的。  2. Context接口 type Context interface { Done() &lt;-chan struct{} Err() error Deadline() (deadline time.Time, ok bool) Value(key interface{}) interface{} } Context是一个接口，其定义非常的简单，只包含4个方法：
  Done() &lt;-chan struct{} Done()方法将一个channel作为取消信号返回给持有context的函数，当该channel被关闭（即Done()被调用），这些函数应该立即停止其工作并返回。
  Err() error Err()返回一个Error，说明为什么取消context。如果Done()没有被调用，那么Err返回nil。
  Deadline() (deadline time.Time, ok bool) Deadline()方法返回持有这个context的函数的预期结束时间。如果并没有设置deadline，那么返回的ok将被设置为false。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Tems",
      "item": "http://lichang.tech/tem/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "golang中context包的使用",
      "item": "http://lichang.tech/tem/golang/golang%E4%B8%ADcontext%E5%8C%85%E7%9A%84%E4%BD%BF%E7%94%A8/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "golang中context包的使用",
  "name": "golang中context包的使用",
  "description": "context包定义了Context类型，这个类型在API边界即进程中传递截止日期、同步信号，请求值等相关信息。\n 1. 对context包的介绍 在服务器的传入请求中应包含context，而对服务器的传出调用应接收一个context。它们之间的调用链必须包含context，或是衍生的WithCancel, WithDeadline, WithTimeout, WithValue。当一个WithCancel Context被“cancel”，那么当前context所派生的所有context也都将被取消。\nWithCancel, WithDeadline, WithTimeout接收一个Context对象（父对象），并返回其父对象的一个携带有cancel/deadline/timeout的一个拷贝（子对象）。调用CancelFunc会取消其子对象及子对象的子对象等，删除父对象对子对象的引用，并停止所有关联的计时器。未能调用CancelFunc将造成父对象结束前或计时器被触发前子对象的泄露。使用go vet工具可以检查所有控制流路径上是否都使用了CancelFunc\n使用context的程序应遵循以下规则，以使各个包之间的接口保持一致，并启用静态分析工具来检查上下文传播：\n 不要将context存储在结构类型中，而是将context明确传递给需要它的每个函数。Context应该是第一个函数，通常命名为ctx。  func DoSomething(ctx context.Context, arg Arg) error { // ...use ctx... } 不要传递一个值为nil的context，即使一个函数允许这样做。如果你不确定Context的作用那就请传递context.TODO。 只在进程和API间传递请求范围数据时使用context值，不要用于将可选参数传递给函数。 同样的Context可以传递给运行在不同goroutine中的函数，Context是线程安全的。  2. Context接口 type Context interface { Done() \u0026lt;-chan struct{} Err() error Deadline() (deadline time.Time, ok bool) Value(key interface{}) interface{} } Context是一个接口，其定义非常的简单，只包含4个方法：\n  Done() \u0026lt;-chan struct{} Done()方法将一个channel作为取消信号返回给持有context的函数，当该channel被关闭（即Done()被调用），这些函数应该立即停止其工作并返回。\n  Err() error Err()返回一个Error，说明为什么取消context。如果Done()没有被调用，那么Err返回nil。\n  Deadline() (deadline time.Time, ok bool) Deadline()方法返回持有这个context的函数的预期结束时间。如果并没有设置deadline，那么返回的ok将被设置为false。",
  "keywords": [
    "golang", "context"
  ],
  "articleBody": " context包定义了Context类型，这个类型在API边界即进程中传递截止日期、同步信号，请求值等相关信息。\n 1. 对context包的介绍 在服务器的传入请求中应包含context，而对服务器的传出调用应接收一个context。它们之间的调用链必须包含context，或是衍生的WithCancel, WithDeadline, WithTimeout, WithValue。当一个WithCancel Context被“cancel”，那么当前context所派生的所有context也都将被取消。\nWithCancel, WithDeadline, WithTimeout接收一个Context对象（父对象），并返回其父对象的一个携带有cancel/deadline/timeout的一个拷贝（子对象）。调用CancelFunc会取消其子对象及子对象的子对象等，删除父对象对子对象的引用，并停止所有关联的计时器。未能调用CancelFunc将造成父对象结束前或计时器被触发前子对象的泄露。使用go vet工具可以检查所有控制流路径上是否都使用了CancelFunc\n使用context的程序应遵循以下规则，以使各个包之间的接口保持一致，并启用静态分析工具来检查上下文传播：\n 不要将context存储在结构类型中，而是将context明确传递给需要它的每个函数。Context应该是第一个函数，通常命名为ctx。  func DoSomething(ctx context.Context, arg Arg) error { // ...use ctx... } 不要传递一个值为nil的context，即使一个函数允许这样做。如果你不确定Context的作用那就请传递context.TODO。 只在进程和API间传递请求范围数据时使用context值，不要用于将可选参数传递给函数。 同样的Context可以传递给运行在不同goroutine中的函数，Context是线程安全的。  2. Context接口 type Context interface { Done() chan struct{} Err() error Deadline() (deadline time.Time, ok bool) Value(key interface{}) interface{} } Context是一个接口，其定义非常的简单，只包含4个方法：\n  Done() Done()方法将一个channel作为取消信号返回给持有context的函数，当该channel被关闭（即Done()被调用），这些函数应该立即停止其工作并返回。\n  Err() error Err()返回一个Error，说明为什么取消context。如果Done()没有被调用，那么Err返回nil。\n  Deadline() (deadline time.Time, ok bool) Deadline()方法返回持有这个context的函数的预期结束时间。如果并没有设置deadline，那么返回的ok将被设置为false。\n  Value(key interface{}) interface{} Value()方法返回与此context关联的key，如果没有与key对应的值那么返回nil。\nkey可以是任何支持比较的类型，为了避免冲突，应将key定义为不可导出的。\n示例：\npackage user import \"context\" type User struct{...} type key int var userKey key func NewContext(ctx context.Context, u *User) context.Context { return context.WithValue(ctx, userKey, u) } func FromContext(ctx context.Context)(*User, bool){ u, ok := ctx.Value(userKey).(*User) return u, ok }   3. Context构造 构造一个context对象有两种方法。\nfunc Background() Context func TODO() Context 上面两个方法都会返回一个非nil，非空的Context对象。Background()一般用于构造出最初的Context，所有的Context都派生自它。TODO()用当传入的方法不确定是哪种类型的Context时，为了避免Context参数为nil而初始化的Context。\n构造出Context对象后，我们就可以使用WithCancel, WithDeadline, WithTimeout, WithValue来进一步的设置Context，构造出的Context都派生自Background或是TODO 4. context.With… 4.1 context.WithCancel() func WithCancel(parent Context) (ctx Context, cancel CancelFunc) WithCancel接收一个父context并返回该父context的一个持有Done channel的子context和一个cancel方法，当cancel方法被调用时或是父context的Done channel被关闭时，当前context的Done channel将被关闭。\nWithCancel常被用于通知goroutine退出。\nfunc fibonacci(c chan int, ctx context.Context) { x, y := 0, 1 for{ select { case c  x: x, y = y, x+y case ctx.Done(): fmt.Println(\"quit\") return } } } func main() { defer func() { time.Sleep(time.Second) fmt.Println(\"the number of goroutines: \", runtime.NumGoroutine()) }() ctx, cancel := context.WithCancel(context.Background()) defer cancel() c := make(chan int) go fibonacci(c, ctx) for i := 0; i 10; i++{ fmt.Println( c) } } 4.2 context.WithValue() func WithValue(parent Context, key, val interface{}) Context WithValue方法接收一个父context，以及一个键值对，返回一个包含这个键值对的子context。可使用context.Value(key)方法取出其中保存的值。\nfunc main() { ctx, cancel := context.WithCancel(context.Background()) valueCtx := context.WithValue(ctx, key, \"add value\") go watch(valueCtx) time.Sleep(10 * time.Second) cancel() time.Sleep(5 * time.Second) } func watch(ctx context.Context) { for { select { case ctx.Done(): //get value \tfmt.Println(ctx.Value(key), \"is cancel\") return default: //get value \tfmt.Println(ctx.Value(key), \"int goroutine\") time.Sleep(2 * time.Second) } } } 4.3 context.WithDeadline() func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) WithDeadline方法接收一个父context和一个截止时间d，返回子context并为其设置一个不晚于d的截止时间。如果父context的截止时间已经早于d, 那么WithDeadline在语义上与父context相同。当以下三种情况发生时：1.截止时间到来，2.cancelFunc被调用，3.父context的Done channel被关闭，当前context的Done channel将被关闭。\nfunc main() { d := time.Now().Add(5 * time.Second) // 5秒后到期 \tctx, cancel := context.WithDeadline(context.Background(), d) defer cancel() // 一个好的习惯是调用cancel()以防止goroutine泄露  go doSomething(ctx) time.Sleep(10 * time.Second) } func doSomething(ctx context.Context) { for { select { case time.After(time.Second): fmt.Println(\"I'm doing some funny things\") case ctx.Done(): // 5秒时到期 \tfmt.Println(ctx.Err()) return } } } I'm doing some funny things I'm doing some funny things I'm doing some funny things I'm doing some funny things context deadline exceeded 4.4 context.WithTimeout() func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) { return WithDeadline(parent, time.Now().Add(timeout)) } 从其实现就可以看出，WithTimeout只是对WithDeadline的进一步封装，这层封装为context设置了一个截止时间，也就是规定了其超时时间。\nfunc main() { ctx, cancel := context.WithTimeout(context.Background(), time.Duration(2*time.Second)) // 超过两秒就退出，不再continue \tdefer cancel() // 一个好的习惯是调用cancel()以防止goroutine泄露  go seek(ctx) time.Sleep(5 * time.Second) } func seek(ctx context.Context) { for { select { case time.After(time.Second): fmt.Println(\"I'm looking for something\") case ctx.Done(): fmt.Println(ctx.Err()) return } } } 5. context包的其他函数 5.1 context.String() 实现fmt.Stringer接口，用于打印context\nfunc main() { backgroundCtx := context.Background() fmt.Println(backgroundCtx) withValueCtx := context.WithValue(backgroundCtx, \"one\", 1) fmt.Println(withValueCtx) withCancelCtx, cancel := context.WithCancel(withValueCtx) defer cancel() fmt.Println(withCancelCtx) d := time.Now().Add(2 * time.Second) withDeadlineCtx, cancel := context.WithDeadline(withCancelCtx, d) defer cancel() fmt.Println(withDeadlineCtx) withTimeoutCtx, cancel := context.WithTimeout(withDeadlineCtx, time.Duration(2 * time.Second)) defer cancel() fmt.Println(withTimeoutCtx) } context.Background context.Background.WithValue(type string, val ) context.Background.WithValue(type string, val ).WithCancel context.Background.WithValue(type string, val ).WithCancel.WithDeadline(2021-05-23 15:49:31.513587636 +0800 CST m=+2.000147913 [1.999897372s]) context.Background.WithValue(type string, val ).WithCancel.WithDeadline(2021-05-23 15:49:31.513587636 +0800 CST m=+2.000147913 [1.999881255s]).WithCancel 5.2 context.Value() 用于从WithValue context中根据key取值\nfunc main() { ctx := context.WithValue(context.Background(), \"one\", 1) fmt.Println(ctx.Value(\"one\")) } 值取出后context不会删除它，可重复取值，对一个不存在的key取值会返回nil。\nReference Package context Go Concurrency Patterns: Context Golang Context深入理解\nGolang Context 原理与实战 Go 语言设计与实现\n",
  "wordCount" : "516",
  "inLanguage": "en",
  "datePublished": "2021-05-23T00:00:00Z",
  "dateModified": "2021-05-23T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "李昌"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://lichang.tech/tem/golang/golang%E4%B8%ADcontext%E5%8C%85%E7%9A%84%E4%BD%BF%E7%94%A8/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Linote",
    "logo": {
      "@type": "ImageObject",
      "url": "https://raw.githubusercontent.com/lich-Img/blogImg/master/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://lichang.tech/" accesskey="h" title="Linote (Alt + H)">Linote</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="http://lichang.tech/archives" title="存档">
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="http://lichang.tech/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="http://lichang.tech/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://lichang.tech/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://lichang.tech/">Home</a>&nbsp;»&nbsp;<a href="http://lichang.tech/tem/">Tems</a></div>
    <h1 class="post-title">
      golang中context包的使用
    </h1>
    <div class="post-meta">May 23, 2021&nbsp;·&nbsp;3 min&nbsp;·&nbsp;李昌
</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <div class="details">Table of Contents</div>
        </summary>
        <div class="inner"><ul>
                <li>
                    <a href="#1-%e5%af%b9context%e5%8c%85%e7%9a%84%e4%bb%8b%e7%bb%8d" aria-label="1. 对context包的介绍">1. 对context包的介绍</a></li>
                <li>
                    <a href="#2-context%e6%8e%a5%e5%8f%a3" aria-label="2. Context接口">2. Context接口</a></li>
                <li>
                    <a href="#3-context%e6%9e%84%e9%80%a0" aria-label="3. Context构造">3. Context构造</a></li>
                <li>
                    <a href="#4-contextwith" aria-label="4. context.With&amp;hellip;">4. context.With&hellip;</a><ul>
                        
                <li>
                    <a href="#41-contextwithcancel" aria-label="4.1 context.WithCancel()">4.1 context.WithCancel()</a></li>
                <li>
                    <a href="#42-contextwithvalue" aria-label="4.2 context.WithValue()">4.2 context.WithValue()</a></li>
                <li>
                    <a href="#43-contextwithdeadline" aria-label="4.3 context.WithDeadline()">4.3 context.WithDeadline()</a></li>
                <li>
                    <a href="#44-contextwithtimeout" aria-label="4.4 context.WithTimeout()">4.4 context.WithTimeout()</a></li></ul>
                </li>
                <li>
                    <a href="#5-context%e5%8c%85%e7%9a%84%e5%85%b6%e4%bb%96%e5%87%bd%e6%95%b0" aria-label="5. context包的其他函数">5. context包的其他函数</a><ul>
                        
                <li>
                    <a href="#51-contextstring" aria-label="5.1 context.String()">5.1 context.String()</a></li>
                <li>
                    <a href="#52-contextvalue" aria-label="5.2 context.Value()">5.2 context.Value()</a></li></ul>
                </li>
                <li>
                    <a href="#reference" aria-label="Reference">Reference</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><blockquote>
<p>context包定义了Context类型，这个类型在API边界即进程中传递截止日期、同步信号，请求值等相关信息。</p>
</blockquote>
<h2 id="1-对context包的介绍">1. 对context包的介绍<a hidden class="anchor" aria-hidden="true" href="#1-对context包的介绍">#</a></h2>
<p>在服务器的传入请求中应包含<code>context</code>，而对服务器的传出调用应接收一个<code>context</code>。它们之间的调用链必须包含<code>context</code>，或是衍生的<code>WithCancel</code>, <code>WithDeadline</code>, <code>WithTimeout</code>, <code>WithValue</code>。当一个<code>WithCancel Context</code>被“cancel”，那么当前<code>context</code>所派生的所有<code>context</code>也都将被取消。</p>
<p><code>WithCancel</code>, <code>WithDeadline</code>, <code>WithTimeout</code>接收一个<code>Context</code>对象（父对象），并返回其父对象的一个携带有<code>cancel/deadline/timeout</code>的一个拷贝（子对象）。调用<code>CancelFunc</code>会取消其子对象及子对象的子对象等，删除父对象对子对象的引用，并停止所有关联的计时器。未能调用<code>CancelFunc</code>将造成父对象结束前或计时器被触发前子对象的泄露。使用<code>go vet</code>工具可以检查所有控制流路径上是否都使用了<code>CancelFunc</code></p>
<p>使用<code>context</code>的程序应遵循以下规则，以使各个包之间的接口保持一致，并启用静态分析工具来检查上下文传播：</p>
<ol>
<li>不要将<code>context</code>存储在结构类型中，而是将<code>context</code>明确传递给需要它的每个函数。<code>Context</code>应该是第一个函数，通常命名为<code>ctx</code>。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DoSomething</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">arg</span> <span style="color:#a6e22e">Arg</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// ...use ctx...
</span><span style="color:#75715e"></span>}
</code></pre></div><ol start="2">
<li>不要传递一个值为nil的<code>context</code>，即使一个函数允许这样做。如果你不确定<code>Context</code>的作用那就请传递<code>context.TODO</code>。</li>
<li>只在进程和API间传递请求范围数据时使用<code>context</code>值，不要用于将可选参数传递给函数。</li>
<li>同样的<code>Context</code>可以传递给运行在不同<code>goroutine</code>中的函数，<code>Context</code>是线程安全的。</li>
</ol>
<h2 id="2-context接口">2. Context接口<a hidden class="anchor" aria-hidden="true" href="#2-context接口">#</a></h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Context</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#a6e22e">Done</span>() <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}
    <span style="color:#a6e22e">Err</span>() <span style="color:#66d9ef">error</span>
    <span style="color:#a6e22e">Deadline</span>() (<span style="color:#a6e22e">deadline</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>)
    <span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">interface</span>{}
}
</code></pre></div><p><code>Context</code>是一个接口，其定义非常的简单，只包含4个方法：</p>
<ul>
<li>
<p>Done() &lt;-chan struct{}
<code>Done()</code>方法将一个<code>channel</code>作为取消信号返回给持有<code>context</code>的函数，当该<code>channel</code>被关闭（即<code>Done()</code>被调用），这些函数应该立即停止其工作并返回。</p>
</li>
<li>
<p>Err() error
<code>Err()</code>返回一个<code>Error</code>，说明为什么取消<code>context</code>。如果<code>Done()</code>没有被调用，那么<code>Err</code>返回nil。</p>
</li>
<li>
<p>Deadline() (deadline time.Time, ok bool)
<code>Deadline()</code>方法返回持有这个<code>context</code>的函数的预期结束时间。如果并没有设置<code>deadline</code>，那么返回的<code>ok</code>将被设置为<code>false</code>。</p>
</li>
<li>
<p>Value(key interface{}) interface{}
<code>Value()</code>方法返回与此<code>context</code>关联的<code>key</code>，如果没有与<code>key</code>对应的值那么返回nil。<br>
<code>key</code>可以是任何支持比较的类型，为了避免冲突，应将<code>key</code>定义为不可导出的。<br>
示例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">user</span>
<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;context&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span>{<span style="color:#f92672">...</span>}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">int</span>

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userKey</span> <span style="color:#a6e22e">key</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewContext</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">u</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">userKey</span>, <span style="color:#a6e22e">u</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">FromContext</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>)(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">bool</span>){
    <span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">userKey</span>).(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">ok</span>
}
</code></pre></div></li>
</ul>
<h2 id="3-context构造">3. Context构造<a hidden class="anchor" aria-hidden="true" href="#3-context构造">#</a></h2>
<p>构造一个<code>context</code>对象有两种方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Background</span>() <span style="color:#a6e22e">Context</span> 

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TODO</span>() <span style="color:#a6e22e">Context</span> 
</code></pre></div><p>上面两个方法都会返回一个非nil，非空的<code>Context</code>对象。<code>Background()</code>一般用于构造出最初的<code>Context</code>，所有的<code>Context</code>都派生自它。<code>TODO()</code>用当传入的方法不确定是哪种类型的<code>Context</code>时，为了避免<code>Context</code>参数为nil而初始化的<code>Context</code>。</p>
<p>构造出<code>Context</code>对象后，我们就可以使用<code>WithCancel</code>, <code>WithDeadline</code>, <code>WithTimeout</code>, <code>WithValue</code>来进一步的设置<code>Context</code>，构造出的<code>Context</code>都派生自<code>Background</code>或是<code>TODO</code>
<img loading="lazy" src="https://raw.githubusercontent.com/lich-Img/blogImg/master/img20210523145028.png" alt="20210523145028"  />
</p>
<h2 id="4-contextwith">4. context.With&hellip;<a hidden class="anchor" aria-hidden="true" href="#4-contextwith">#</a></h2>
<h3 id="41-contextwithcancel">4.1 context.WithCancel()<a hidden class="anchor" aria-hidden="true" href="#41-contextwithcancel">#</a></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">parent</span> <span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#a6e22e">CancelFunc</span>) 
</code></pre></div><p><code>WithCancel</code>接收一个父<code>context</code>并返回该父<code>context</code>的一个持有<code>Done channel</code>的子<code>context</code>和一个<code>cancel</code>方法，当<code>cancel</code>方法被调用时或是父<code>context</code>的<code>Done channel</code>被关闭时，当前<code>context</code>的<code>Done channel</code>将被关闭。</p>
<p><code>WithCancel</code>常被用于通知<code>goroutine</code>退出。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">fibonacci</span>(<span style="color:#a6e22e">c</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>)  {
	<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>
	<span style="color:#66d9ef">for</span>{
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">x</span>:
			<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> = <span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">x</span><span style="color:#f92672">+</span><span style="color:#a6e22e">y</span>
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;quit&#34;</span>)
			<span style="color:#66d9ef">return</span>
		}
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;the number of goroutines: &#34;</span>, <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">NumGoroutine</span>())
	}()
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()

	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">fibonacci</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">ctx</span>)

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>{
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>)
	}
}
</code></pre></div><h3 id="42-contextwithvalue">4.2 context.WithValue()<a hidden class="anchor" aria-hidden="true" href="#42-contextwithvalue">#</a></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">parent</span> <span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">val</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#a6e22e">Context</span> 
</code></pre></div><p><code>WithValue</code>方法接收一个父<code>context</code>，以及一个键值对，返回一个包含这个键值对的子<code>context</code>。可使用<code>context.Value(key)</code>方法取出其中保存的值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())

	<span style="color:#a6e22e">valueCtx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">key</span>, <span style="color:#e6db74">&#34;add value&#34;</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">valueCtx</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">cancel</span>()

	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
			<span style="color:#75715e">//get value
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">key</span>), <span style="color:#e6db74">&#34;is cancel&#34;</span>)

			<span style="color:#66d9ef">return</span>
		<span style="color:#66d9ef">default</span>:
			<span style="color:#75715e">//get value
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">key</span>), <span style="color:#e6db74">&#34;int goroutine&#34;</span>)

			<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		}
	}
}
</code></pre></div><h3 id="43-contextwithdeadline">4.3 context.WithDeadline()<a hidden class="anchor" aria-hidden="true" href="#43-contextwithdeadline">#</a></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithDeadline</span>(<span style="color:#a6e22e">parent</span> <span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">d</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) (<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">CancelFunc</span>)
</code></pre></div><p><code>WithDeadline</code>方法接收一个父<code>context</code>和一个截止时间<code>d</code>，返回子<code>context</code>并为其设置一个不晚于<code>d</code>的截止时间。如果父<code>context</code>的截止时间已经早于<code>d</code>, 那么<code>WithDeadline</code>在语义上与父<code>context</code>相同。当以下三种情况发生时：1.截止时间到来，2.<code>cancelFunc</code>被调用，3.父<code>context</code>的<code>Done channel</code>被关闭，当前<code>context</code>的<code>Done channel</code>将被关闭。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>) <span style="color:#75715e">// 5秒后到期
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithDeadline</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">d</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>() <span style="color:#75715e">// 一个好的习惯是调用cancel()以防止goroutine泄露
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">doSomething</span>(<span style="color:#a6e22e">ctx</span>)

	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">doSomething</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>):
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;I&#39;m doing some funny things&#34;</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():  <span style="color:#75715e">// 5秒时到期
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>())
			<span style="color:#66d9ef">return</span>
		}
	}
}
</code></pre></div><pre><code>I'm doing some funny things
I'm doing some funny things
I'm doing some funny things
I'm doing some funny things
context deadline exceeded
</code></pre><h3 id="44-contextwithtimeout">4.4 context.WithTimeout()<a hidden class="anchor" aria-hidden="true" href="#44-contextwithtimeout">#</a></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">parent</span> <span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">timeout</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) (<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">CancelFunc</span>) {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">WithDeadline</span>(<span style="color:#a6e22e">parent</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">timeout</span>))
}
</code></pre></div><p>从其实现就可以看出，<code>WithTimeout</code>只是对<code>WithDeadline</code>的进一步封装，这层封装为<code>context</code>设置了一个截止时间，也就是规定了其超时时间。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)) <span style="color:#75715e">// 超过两秒就退出，不再continue
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>() <span style="color:#75715e">// 一个好的习惯是调用cancel()以防止goroutine泄露
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">seek</span>(<span style="color:#a6e22e">ctx</span>)

	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">seek</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>):
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;I&#39;m looking for something&#34;</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>())
			<span style="color:#66d9ef">return</span>
		}
	}
}
</code></pre></div><h2 id="5-context包的其他函数">5. context包的其他函数<a hidden class="anchor" aria-hidden="true" href="#5-context包的其他函数">#</a></h2>
<h3 id="51-contextstring">5.1 context.String()<a hidden class="anchor" aria-hidden="true" href="#51-contextstring">#</a></h3>
<p>实现<code>fmt.Stringer</code>接口，用于打印<code>context</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">backgroundCtx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">backgroundCtx</span>)

	<span style="color:#a6e22e">withValueCtx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">backgroundCtx</span>, <span style="color:#e6db74">&#34;one&#34;</span>, <span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">withValueCtx</span>)

	<span style="color:#a6e22e">withCancelCtx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">withValueCtx</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">withCancelCtx</span>)

	<span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">withDeadlineCtx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithDeadline</span>(<span style="color:#a6e22e">withCancelCtx</span>, <span style="color:#a6e22e">d</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">withDeadlineCtx</span>)

	<span style="color:#a6e22e">withTimeoutCtx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">withDeadlineCtx</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>))
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">withTimeoutCtx</span>)
}
</code></pre></div><pre><code>context.Background
context.Background.WithValue(type string, val &lt;not Stringer&gt;)
context.Background.WithValue(type string, val &lt;not Stringer&gt;).WithCancel
context.Background.WithValue(type string, val &lt;not Stringer&gt;).WithCancel.WithDeadline(2021-05-23 15:49:31.513587636 +0800 CST m=+2.000147913 [1.999897372s])
context.Background.WithValue(type string, val &lt;not Stringer&gt;).WithCancel.WithDeadline(2021-05-23 15:49:31.513587636 +0800 CST m=+2.000147913 [1.999881255s]).WithCancel
</code></pre><h3 id="52-contextvalue">5.2 context.Value()<a hidden class="anchor" aria-hidden="true" href="#52-contextvalue">#</a></h3>
<p>用于从<code>WithValue context</code>中根据<code>key</code>取值</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;one&#34;</span>, <span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#e6db74">&#34;one&#34;</span>))
}
</code></pre></div><p>值取出后<code>context</code>不会删除它，可重复取值，对一个不存在的<code>key</code>取值会返回nil。</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lich-Img/blogImg/master/context.png" alt="context"  />
</p>
<h2 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h2>
<p><a href="https://golang.org/pkg/context/">Package context</a>  <br>
<a href="https://blog.golang.org/context">Go Concurrency Patterns: Context</a> <br>
<a href="https://juejin.cn/post/6844903555145400334">Golang Context深入理解</a><br>
<a href="https://segmentfault.com/a/1190000022534841">Golang Context 原理与实战</a> <br>
<a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-context/">Go 语言设计与实现</a></p>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://lichang.tech/tags/golang/">GoLang</a></li>
      <li><a href="http://lichang.tech/tags/context/">context</a></li>
    </ul>

<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share golang中context包的使用 on twitter"
        href="https://twitter.com/intent/tweet/?text=golang%e4%b8%adcontext%e5%8c%85%e7%9a%84%e4%bd%bf%e7%94%a8&amp;url=http%3a%2f%2flichang.tech%2ftem%2fgolang%2fgolang%25E4%25B8%25ADcontext%25E5%258C%2585%25E7%259A%2584%25E4%25BD%25BF%25E7%2594%25A8%2f&amp;hashtags=golang%2ccontext">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share golang中context包的使用 on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flichang.tech%2ftem%2fgolang%2fgolang%25E4%25B8%25ADcontext%25E5%258C%2585%25E7%259A%2584%25E4%25BD%25BF%25E7%2594%25A8%2f&amp;title=golang%e4%b8%adcontext%e5%8c%85%e7%9a%84%e4%bd%bf%e7%94%a8&amp;summary=golang%e4%b8%adcontext%e5%8c%85%e7%9a%84%e4%bd%bf%e7%94%a8&amp;source=http%3a%2f%2flichang.tech%2ftem%2fgolang%2fgolang%25E4%25B8%25ADcontext%25E5%258C%2585%25E7%259A%2584%25E4%25BD%25BF%25E7%2594%25A8%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share golang中context包的使用 on reddit"
        href="https://reddit.com/submit?url=http%3a%2f%2flichang.tech%2ftem%2fgolang%2fgolang%25E4%25B8%25ADcontext%25E5%258C%2585%25E7%259A%2584%25E4%25BD%25BF%25E7%2594%25A8%2f&title=golang%e4%b8%adcontext%e5%8c%85%e7%9a%84%e4%bd%bf%e7%94%a8">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share golang中context包的使用 on facebook"
        href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flichang.tech%2ftem%2fgolang%2fgolang%25E4%25B8%25ADcontext%25E5%258C%2585%25E7%259A%2584%25E4%25BD%25BF%25E7%2594%25A8%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share golang中context包的使用 on whatsapp"
        href="https://api.whatsapp.com/send?text=golang%e4%b8%adcontext%e5%8c%85%e7%9a%84%e4%bd%bf%e7%94%a8%20-%20http%3a%2f%2flichang.tech%2ftem%2fgolang%2fgolang%25E4%25B8%25ADcontext%25E5%258C%2585%25E7%259A%2584%25E4%25BD%25BF%25E7%2594%25A8%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share golang中context包的使用 on telegram"
        href="https://telegram.me/share/url?text=golang%e4%b8%adcontext%e5%8c%85%e7%9a%84%e4%bd%bf%e7%94%a8&amp;url=http%3a%2f%2flichang.tech%2ftem%2fgolang%2fgolang%25E4%25B8%25ADcontext%25E5%258C%2585%25E7%259A%2584%25E4%25BD%25BF%25E7%2594%25A8%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    <footer class="footer">
    <span>&copy; 2021 <a href="http://lichang.tech/">Linote</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/contrib/auto-render.min.js"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
	          renderMathInElement(document.body, {
			                delimiters: [
						                  {left: "$$", right: "$$", display: true},
								                    {left: "$", right: "$", display: false}
					              ]
							                });
		      });
    </script>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
